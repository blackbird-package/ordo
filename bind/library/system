#!/bin/bash

## CORE SYSTEM PROTOCOL BLACKBIRD LEVEL 1
## lead : AL Muhdil Karim
## team : 



##
## KERNEL MODULE
RAMFSMOD=()
RAMFSBIN=()
RAMFSFIL=()
KERNMODS=()
KERNSECS=()
KERNPERF=()
KERNMISC=("rw" "quiet" )


function blackbird_regramf_mods() {
    RAMFSMOD+=($1)
}


function blackbird_regramf_bins() {
    RAMFSBIN+=($1)
}


function blackbird_regramf_file() {
    RAMFSFIL+=($1)
}


function blackbird_regramf_mods() {
    KERNMODS+=($1)
}


function blackbird_regramf_secs() {
    KERNSECS+=($1)
}


function blackbird_regramf_perf() {
    KERNPERF+=($1)
}

function blackbird_regramf_misc() {
    KERNMISC+=($1)
}



##
## PROCESOR MODULE
function blackbird_system_process_module() {

    if [[ $SYSPROCS == "intel" ]];then
        blackbird_regpack_main "intel-ucode"

    elif [[ $SYSPROCS == "amd" ]];then
        blackbird_regpack_main "amd-ucode"
    fi
}


##
## GRAPHIC MODULE
function blackbird_system_graphic_module_intels() {

    if [[ $SYSKERNL == "linux-hardened" ]];then

        echo "display driver is intel at linux-hardened"

    else
        echo "display driver is intel"

    fi
}


function blackbird_system_graphic_module_optinv() {

    if [[ $SYSKERNL == "linux-hardened" ]];then

        blackbird_regpack_main "linux-hardened-headers"
        echo "display driver is optimus intel and nvdia at linux-hardened"

    else
        echo "display driver is optimus"
    fi
}


function blackbird_system_graphic_module_nvidia() {
    
    if [[ $SYSKERNL == "linux-hardened" ]];then
        echo "display driver is nvidia at linux-hardened"

    else
        echo "display driver is nvidia"

    fi
}


function blackbird_system_graphic_module_atirad() {

    if [[ $SYSKERNL == "linux-hardened" ]];then
        echo "display driver is radeon at linux-hardened"

    else
        echo "display driver is radeon"

    fi
}


function blackbird_system_graphic_module() {

    if [[ $( echo ${SYSDISPL[*]} | grep "intel nvidia" ) ]];then

        blackbird_system_graphic_module_optinv

    elif [[ $( echo ${SYSDISPL[*]} | grep "nvidia" ) ]];then

        blackbird_system_graphic_module_nvidia
        
    elif [[ $( echo ${SYSDISPL[*]} | grep "radeon" ) ]];then

        blackbird_system_graphic_module_atirad

    elif [[ $( echo ${SYSDISPL[*]} | grep "intel" ) ]];then

        blackbird_system_graphic_module_intels
        
    fi
}

function blackbird_systems_prepare_main() {
    blackbird_system_process_module
    blackbird_system_graphic_module
}


##
## SYSTEM PREPARATION INIT

function blackbird_systems_storage_fstab() {
    
    genfstab -U /mnt > /mnt/etc/fstab
}


function blackbird_systems_storage_tmpfs() {
    
    if [[ ! -z $SRAM_TMPS ]];then
        echo "tmpfs     /tmp        tmpfs   defaults,rw,nosuid,nodev,noexec,relatime,size=$SRAM_TMPS    0 0" >> /mnt/etc/fstab
    fi
}


function blackbird_systems_storage_shmfs() {
    
    if [[ ! -z $SRAM_SHMS ]];then
        echo "tmpfs     /dev/shm    tmpfs   defaults,rw,nosuid,nodev,noexec,relatime,size=$SRAM_SHMS    0 0" >> /mnt/etc/fstab
    fi
}


function blackbird_systems_fakeuser_prep() {
    rootc "useradd -u 5000 -g 5000 installman"
    echo "installman ALL=(ALL) NOPASSWD:ALL" > /mnt/etc/sudoers.d/5000_installman
}


function blackbird_systems_install_prep() {
    
    blackbird_scope_init "TMPFS Storage Pool"

    blackbird_progress "generate partition layout"
    blackbird_systems_storage_fstab
    blackbird_done


    blackbird_progress "create tmp partition"
    blackbird_systems_storage_tmpfs
    blackbird_done


    blackbird_progress "create shm partition"
    blackbird_systems_storage_shmfs
    blackbird_done


    blackbird_systems_fakeuser_prep

    blackbird_scope_done   
}


##
## SYSTEM PREPARATION DONE

function blackbird_systems_fakeuser_done() {
    rootc "userdel -m installman"
    rm /mnt/etc/sudoers.d/5000_installman
}


function blackbird_systems_install_done() {
    rootc "mkinitpcio -P"
   
}


